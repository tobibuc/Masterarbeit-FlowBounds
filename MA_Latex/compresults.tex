% The models we described have also been implemented and tested on networks of different size.
In this section we will discuss the practical implementations and present results of the computation. For relevant 
real-world problem sizes the exact models are too slow, even with separation of the acyclicity constraints. For this 
reason we also describe how to relax the problem in order to get useable (though in general not optimal) results for the 
flow bounds. 
We compare the bounds found by different approaches and with different settings (different networks and nominations) 
to see which approach is suited best to actually compute acyclic flow bounds in a network. We also describe in short 
how the standard bounds we used to compare the results to are computed. 

At last we compare the impact of bounds and the number of fixed variables fed into the solver on the model sizes of the 
discretization. \\

\subsection{Implemented Algorithms}

We described the theoretical backgrounds of different algorithms to obtain flow bounds for our problem. The 
computational results of different implementations of them may vary widely, and the performance is influenced by lots 
of details regarding the machines, programming languages, data structures or just code quality. Nevertheless we want 
to give an overview what worked well in the implementation and what did not.\\

All algorithms where tested on a PC with instances of the \textit{"gaslib"} gasnet test library. The library can be 
downloaded on \url{http://gaslib.zib.de/}. A detailed description of this problem library can be found in 
\cite{HumpolaJoormannOucherifPfetschScheweSchmidtSchwarz:2015}.
%TODO muss ich den PC mit Anzahl kernen etc spezifizieren?!?

\subsubsection{MIP with Node Potentials and Binary Direction Variables}
The MIP model described in \ref{model:nodePotential} was implemented in Lamatto, using Gurobi as solver for this 
model. However,the two layers of indicator constraints seem to be a heavy problem of the model in 
practice. The following model was implemented:
\begin{align*}
  &\min \sum_{a\in A} w_a\cdot q_a & \\
 s.t. & \sum_{a\in \delta^+(v)}q_a - \sum_{a\in\delta^- (v)}q_a &=& d_v\ &\forall v\in V \\
 & q_a &\le& c_u(a) & \forall a\in A\\
 & q_a &\ge& c_l(a) & \forall a\in A\\
 & \rho_{vw}=1 &\Rightarrow &\pi_v\ge\pi_w +1 & \forall (v,w)\in A\\
 & \rho_{vw}=0 &\Rightarrow &\pi_w\ge\pi_v +1& \forall (v,w)\in A\\
 & \rho_{vw}=1 &\Rightarrow &q((v,w))\ge 0& \forall (v,w)\in A\\
 & \rho_{vw}=0 &\Rightarrow &q((v,w))\le 0& \forall (v,w)\in A\\
 & q_a \in \R & & &\forall a\in A\\
 & \pi_v \in \R & & & \forall v\in V\\
 & d_a \in \{0,1\} & & &\forall a\in A\\
 & \rho_{vw} \in \{0,1\}&&& \forall a=(v,w)\in A\\
\end{align*}
Integer node potentials imply the direction of the arc between the incident nodes. These binary direction 
variables again imply the sign of the actual flow on an arc. Indicator constraints are usually implemented via 
Big-M-constraints of the form 
\begin{align*}
 &\pi_v-\pi_w &\ge & N(\rho_{vw}-1)+1\\
 &\pi_v-\pi_w&\le &N\rho_{vw}-1 \\
 &q((v,w))&\ge& M(\rho_{vw}-1)\\
 &q((v,w))&\le & M\rho_{vw}\\
 &\rho_{vw} \in \{0,1\}&&\\
\end{align*}
with sufficient big values for $M$ and $N$. This model heavily relies on the Big-M constraints.
For any MIP solver these indicator or Big-M constraints are difficult to handle, because the optimal vertex of the LP 
polyhedron can be quite far from the optimal mixed integer solution.\\

The model was tested on the smallest network named "gaslib-40" of the gaslib package. After running the algorithm for 5 
seconds the optimal bounds for all arcs of the network were computed. The results were the same as with the Acyclicity 
Constraint (separation) Model, apart from numerical rounding differences. \\

On the medium size network "gaslib-135" of the gaslib package TODO

%TODO testergebnisse (vermutlich fail nach etlichen tagen)

\subsubsection{MIP with Binary Direction Variables and separated Acyclicity Constraints}
In section \ref{model:AcyclicityConstraints} we described a model using acyclicity constraints on the binary directions 
for each cycle that was found during the solving process.
This model itself is independent of the implementation of the acyclicity constraints. But since a graph can have an 
exponential number of cycles, writing down all constraints of the model alone could take exponential time. The 
model redundancies we described in \ref{prop:redundantAcyclicityCons} are not enough to sufficiently reduce the model 
size - in fact it could happen that the conditions for \ref{prop:redundantAcyclicityCons} do not apply at all in 
certain networks (though we also did not proof that a clever generalization of the proposition couldn't do better). 
For example the condition of the proposition states that there have to be two cycles with exactly one arc in common. 
But there are of course example networks not containing any two cycles like this. (You could just subdivide every arc 
in a network. Then every two cycles have at least two arcs in common.)\\

So the implementation does not add all the acyclicity constraints explicitely. Instead, the MIP Solver gets a 
general constraint that demands that there is no cyclic flow in the network. When this constraint is checked and there 
is cyclic flow somewhere in the network, a new linear acyclicity constraint on the cycle with the detected cyclic flow 
is added. An Acyclicity Constraint Handler was implemented for this thesis in Lamatto with SCIP as MIP solver. \\

Like the other exact model with node potentials this model takes lots of time to compute the optimal solution. In 
a network there are huge numbers of arcs to be computed that yield similar subproblems, some of them being 
difficult and running very long. Like in the Node Potential Model we could only produce an exact solution for the 
"gaslib-40" network while the algorithm was running too long on the other gaslib test instances.

\subsubsection{Relaxations of the Exact Separation Model}
If we want to have fast answers or compute bigger networks the exact model with separation of acyclicity 
constraints does not work in practice. Nevertheless this model gives us an interesting relaxation of the acyclic 
flowbound problem for free: 

We can limit the time or the number of nodes in the branch and bound tree for each arc in the network. If an optimal 
solution can be found with low effort, we get the optimum bound. If the situation is difficult and we run into the limit 
we just take the dual bound of the mixed integer program. This number is always an upper bound because it is always 
greater or equal to the optimum (which is the maximum flow). \\

With this algorithm we will always get some solution. This solution might be $\infty$. To get rid of the infinite 
values, we can combine it with a simple bound estimate. For example we can take the sum of all ingoing flow as upper 
bound for all arcs with a dual bound that is greater than this. Depending on the preset limit this dual solution could
closer to or further from the optimum. 

This relaxation was implemented with a limit on the nodes and is compared to 
others in the tables below. The tables refer to this relaxation as "sepa\_X" for the exact MIP with separation of 
acyclicity constraints and a node limit of \textit{X} in the branch and bound process of the MIP.

\subsubsection{Acyclicity Constraints on a Cycle Base}% this is roberts code, props to him!
This idea was the starting point of this thesis and implemented by Robert Schwarz some time before. It is like the 
former an incomplete application of the acyclicity constraints. It adds all its acyclicity constraints in the 
beginning. The advantages are easier implementation and hope for a faster running time since the solver does not need 
to add new constraints all the time.

We have seen in \ref{bild:reichtkreisbasis2} that the acyclicity constraints of a small subset of the cycles (like a 
cycle base) do not suffice to forbid cyclic flow  in the network. Still we can try to use them as a relaxation to the 
exact problem. This will already avoid cyclic flow on single cycles that are not touching each other. The tables show 
how the idea works out in practice.

\subsubsection{Cyclic Flow Bounds}%describe the exactfb algo implemented before
\label{model:cyclicFlow}
To start a comparison we need a bound value to which we can compare. This value should be one that is fast and 
easy to compute, in some way sensible and not too far away from a realistic solution, and of course a valid upper 
bound. 
One of the first algorithmic problems that one might think of after seeing the flowbound problem is the normal minimum 
cost flow problem \ref{def:mincostflow}. Setting a negative weight on only one arc in the network will 
maximize flow on this specific arc. We described the connections with this problem in section \ref{sect:mincostflow}. 

We can set the maximal flow capacity on an arc to the natural upper bound "sum of all ingoing flow" if no tighter 
capacity bounds are given. This is a very easy condition derived from the acyclicity and can always be applied.

This model is also implemented in Lamatto. It is modeled as a mixed integer programm with only flow balance and 
capacity constraints. Binary directions are not contained in this model. Because this MIP model also served as the 
basis for the more specific MIP models it is a relaxation of all the others which just add some more constraints or 
variables.

We will refer to this model as "cyclic bounds" respectively "cyclic bounds + flowsum" in the tables below. We compare 
the bounds from the different algorithms to the bounds found with this approach. 


\subsection{Tables}
\subsubsection{Bound Improvements}
\begin{center}

\begin{tabular}{ l | c | c | c | c }
\textbf{gaslib-40} & Time  & Fixed Flows & Bounds tightened & avg improvement\\
\hline
 cyclic bounds& $<1$ s& 21 & [-48] & [-7825.0] \\
 cyclic bounds+flowsum& $<1$ s& 21 & - & - \\
 cycle base& $1$ s & 21 & 48 & 1372.4\\
 heuristic& $<1$ s& 21& 0 & 0\\
 node potential& $4$ s& 21 & 48 & 1372.4 \\ 
 sepa\_all& $112$ s& 21 & 48 & 1372.4\\
\end{tabular} 
\end{center}
%ergebnisse fuer 135: nodepotential hatte gerade einmal das erste pipe berechnet (600) mit beiden schranken, nach 293 h 
%rechenzeit, sepa (auf nur einem kern aber im gleichen rechner) war ebenfalls nicht fertig

\begin{center}
\begin{tabular}{ l | c | c | c | c }
\textbf{gaslib-582 warm\_1111} & Time  & Fixed Flows & Bounds tightened & avg improvement \\
\hline
%  cyclic bounds& $<1s$ & 21 & [-48] & [-7825.0] \\
 cyclic bounds+flowsum& $1$ s& 365 & - & -\\
 cycle base& $ $ &  &  &\\
 heuristic& $ 11$ s& 365& 164 & 5047.2 \\
 node potential& $ $ &  &  &   \\ 
 sepa\_1000& $ 50$ min & 382 & 107 & 3802.1 \\
 sepa\_5000& $ 159$ min & 382 & 180 & 3971.6 \\
 sepa\_20000& $ 281$ min & 382 & 264 & 4312.5 \\
 sepa\_60000& $702$ min  & 382& 278& 4267.7\\
\end{tabular} 
\end{center}

\begin{center}
\begin{tabular}{ l | c | c | c | c }

\textbf{gaslib-582 cool\_12} & Time  & Fixed Flows & Bounds tightened & avg improvement\\
\hline
%  cyclic bounds& $<1s$ & 21 & [-48] & [-7825.0] \\
 cyclic bounds+flowsum& $1$ s & 365 & - & - \\
 cycle base& $ $ &  &  & \\
 heuristic& $11$ s & 365 & 164 & 4050.9 \\
 node potential& $ $ &  &  &    \\ 
 sepa\_1000& $ 50$ min  & 378 & 100 & 3025.2\\
 sepa\_5000& $ 158$ min & 378 & 211 & 3525.6\\ 
 sepa\_20000& $ 361$ min & 378 & 242 & 3648.3  \\
 sepa\_60000& $678$ min  & 378 & 276 & 3390.3 \\
\end{tabular} 
\end{center}

\begin{center}
\begin{tabular}{ l | c | c | c | c }

\textbf{gaslib-582 cold\_100} & Time  & Fixed Flows & Bounds tightened & avg improvement\\
\hline
%  cyclic bounds& $<1s$ & 21 & [-48] & [-7825.0] \\
 cyclic bounds+flowsum& $1s$ & 365 & - & -  \\
 cycle base& $ $ &  &  & \\
 heuristic& $ 10s $& 365& 164 & 5157.4\\
 nodepot\_500000& $123$ min &  &  &   \\ 
 nodepot\_500000& $123$ min &  &  &   \\ 
 nodepot\_500000& $123$ min &  &  &   \\ 
 sepa\_1000& $50$ min  & 378 & 88 & 4265.5 \\
 sepa\_5000& $ 127$ min & 378 & 242 & 4508.9  \\
 sepa\_20000& $ 382$ min &  378& 241 & 4526.3  \\
 sepa\_60000& $635$ min  & 378& 283& 4200\\
\end{tabular} 
\end{center}

\begin{center}
\begin{tabular}{ l | c | c | c | c }

\textbf{gaslib-582 freezing\_1} & Time  & Fixed Flows & Bounds tightened & avg improvement\\
\hline
%  cyclic bounds& $<1s$ & 21 & [-48] & [-7825.0] \\
 cyclic bounds+flowsum& $1s$ & 365 & - & - \\
 cycle base& $ $ &  &  & \\
 heuristic& $ 11$s& 365& 148 & 6148.2\\
 nodepot\_5000& $ 5$ min/8 cores & 365 & 0 & 0 \\ 
 nodepot\_60000& $18$ min /8 cores & 366 & 51 & 4123.2 \\ 
 nodepot\_500000& $127$ min/8 cores &366  & 57 & 4224.7 \\ 
 sepa\_1000& $50$ min & 374 & 90 & 5405.4 \\
 sepa\_5000& $ 154$ min & 374 & 231 & 5104  \\
 sepa\_20000& $366$ min & 374 & 244 & 4929.8 \\
 sepa\_60000& $593$ min & 374 & 276 & 4777.6\\
 sepa\_300000& $3135$ min & 374 & 295 & 4652.8\\
\end{tabular} 
\end{center}

\begin{center}
\begin{tabular}{ l | c | c | c | c }

\textbf{gaslib-582 mild\_10} & Time  & Fixed Flows & Bounds tightened & avg improvement\\
\hline
%  cyclic bounds& $<1s$ & 21 & [-48] & [-7825.0] \\
 cyclic bounds+flowsum& $1$ s& 365 & - & -\\
 cycle base& $ $ &  &  & \\
 heuristic& $11$ s& 365 & 164 & 4291.5\\
 node potential& $ $ &  &   &  \\ 
 nodepot\_500000& $135$ min/8 cores &  &  &  \\ 
 sepa\_1000& $50$ min & 378 & 105 & 3271.3 \\
 sepa\_5000& $ 158$ min  & 378 & 188 & 3329.5 \\
 sepa\_20000& $ 394$ min & 378 & 216 &3144.6 \\
 sepa\_60000& $651$ min  & 378& 289 & 3593.3 \\
\end{tabular} 
\end{center}

The results show that in all cases the bounds get better with more time for the separation algorithm, while the exact 
models need too much time. The heuristics results are weak, but far better than setting the limit to only 1000 nodes. 
%TODO mehr schreiben hier
The bounds computed can be read in and used by the solver to improve building of other models like the discretization. 
The impact of the computed flow bounds on this model is shown in the tables below.

\subsubsection{Model building impact}
\begin{center}
\begin{tabular}{ l | c | c | c | c | c }
\textbf{gaslib-40} & Fixed Dirs(of 45) & nonlinear f. & variables (cont,discr)&constraints\\
\hline
 cyclic bounds&24 & 57& 1477 (948+529)&2009 \\
 cyclic bounds+flowsum& 24 & 57& 1477 (948+529)&2009 \\
 cycle base& 26 & 57 & 955 (687+268)  & 1473\\
 heuristic& 24 & 57& 1477 (948+529)&2009&\\
 node potential& 25 &57  &955 (687+268)  &1473  \\ 
 sepa& 34 &57  &955 (687+268)  &1473 \\
\end{tabular} 
\end{center}
If we compare the results on this small gaslib-40 network with its table of bound values there are two interesting 
points. In building the model there is no difference between the cyclic bounds that were computed with respect to the 
sum of ingoing flow and the ones were the sum of ingoing flow was not set as upper flow bound. Obviously these bounds 
are already used implicitely. Nevertheless it is worth using these natural bounds already in the bound computation, 
since the separation algorithms run much faster and give better results when they are given these bounds before. 

The second point is that the number of fixed flow directions in the last two entries increases a lot, although the 
exact algorithms both found the same optimal solution. The reason is a single numerical difference. It might be useful 
to round values which are extremely close to zero (like this $1^{-10}$) to get more fixations for the model. 

\begin{center}
\begin{tabular}{ l | c | c | c | c | c }
\textbf{gaslib-582 cold\_100} & Fixed Dirs(of 609) & nonlinear f. & variables (cont,discr)&constraints\\
\hline
%  cyclic bounds& $<1s$ & 21 & [-48] & [-7825.0] \\
 cyclic bounds+flowsum& 440 & 241& 5727 (4113+1614)&8216 \\
%  cycle base& $ $ &  &  & \\
 heuristic& 440& 241 & 5675 (4087+1588)&8162\\
%  node potential& $ $ &  &  &  \\ 
 sepa\_1000& 467 & 237& 5471 (3977+1944) & 7930 \\
 sepa\_5000& 467& 237& 5185 (3834+1351)& 7641  \\
 sepa\_20000& 467 & 237 & 5185 (3834+1351)& 7640 \\
 sepa\_60000& 469 &237 & 4903 (3693+1210)& 7339 \\
\end{tabular} 
\end{center}

\begin{center}
\begin{tabular}{ l | c | c | c | c | c }
\textbf{gaslib-582 freezing\_1} & Fixed Dirs(of 609) & nonlinear f. & variables (cont,discr)&constraints\\
\hline
%  cyclic bounds& $<1s$ & 21 & [-48] & [-7825.0] \\
 cyclic bounds+flowsum& 438 & 241& 5757 (4128+1629)&8246 \\
%  cycle base& $ $ &  &  & \\
 heuristic& 438& 241 & 5701 (4100+1601)&8188\\
%  node potential& $ $ &  &  &  \\ 
 sepa\_1000& 466 & 237& 5443 (3963+1480) & 7905 \\
 sepa\_5000& 469& 237& 5171 (3827+1344)& 7632  \\
 sepa\_20000& 466 & 237 & 5099 (3791+1308)& 7553 \\
 sepa\_60000& 472 &237 & 4747 (3615+1132)& 7192 \\
\end{tabular} 
\end{center}


\begin{center}
\begin{tabular}{ l | c | c | c | c | c }
\textbf{gaslib-582 cool\_12} & Fixed Dirs(of 609) & nonlinear f. & variables (cont,discr)&constraints\\
\hline
%  cyclic bounds& $<1s$ & 21 & [-48] & [-7825.0] \\
 cyclic bounds+flowsum& 450 & 241& 5427 (3963+1464)&7926 \\
%  cycle base& $ $ &  &  & \\
 heuristic& 450& 241 & 5371 (3935+1436)&7868\\
%  node potential& $ $ &  &  &  \\ 
 sepa\_1000& 480 & 237& 4993 (3738+1255) & 7464 \\
 sepa\_5000& 480& 237& 4805 (3644+1161)& 7268  \\
 sepa\_20000& 480 & 237 & 4803 (3643+1160)& 7266 \\
 sepa\_60000& 482 &237 & 4655 (3569+1086)& 7099 \\
\end{tabular} 
\end{center}
\begin{center}
\begin{tabular}{ l | c | c | c | c | c }

\textbf{gaslib-582 mild\_10} & Fixed Dirs(of 609) & nonlinear f. & variables (cont,discr)&constraints\\
\hline
%  cyclic bounds& $<1s$ & 21 & [-48] & [-7825.0] \\
 cyclic bounds+flowsum& 458 & 241& 5569 (4034+1535)&8077 \\
%  cycle base& $ $ &  &  & \\
 heuristic& 458& 241 & 5491 (3995+1496)&7997\\
%  node potential& $ $ &  &  &  \\ 
 sepa\_1000& 488 & 237& 4991 (3737+1254) & 7469 \\
 sepa\_5000& 490& 237& 4871 (3677+1194)& 7344  \\
 sepa\_20000& 492 & 237 & 4709 (3596+1113)& 7163 \\
 sepa\_60000& 494 &237 & 4675 (3579+1096)& 7117 \\
\end{tabular} 
\end{center}
\begin{center}
\begin{tabular}{ l | c | c | c | c | c }

\textbf{gaslib-582 warm\_1111} & Fixed Dirs(of 609) & nonlinear f. & variables (cont,discr)&constraints\\
\hline
%  cyclic bounds& $<1s$ & 21 & [-48] & [-7825.0] \\
 cyclic bounds+flowsum& 458 & 241& 5673 (4086+1587)&8183 \\
%  cycle base& $ $ &  &  & \\
 heuristic& 458& 241 & 5589 (4044+1545)&8097\\
%  node potential& $ $ &  &  &  \\ 
 sepa\_1000& 487 & 237& 4865 (3674+1191) & 7335 \\
 sepa\_5000& 492& 237& 4745 (3614+1131)& 7212  \\
 sepa\_20000& 494 & 237 & 4433 (3458+975)& 6886 \\
 sepa\_60000& 496 &237 & 4371 (3427+944)& 6823 \\
\end{tabular} 
\end{center}

For the big networks we are only able to compare the results of heuristics because the exact algorithms take far 
too long for solving. The tables show that improved bounds yield a smaller model. The more nodes we allow in the 
separation process, the tighter the bounds. With tighter bounds we get a smaller model. Hence it could in fact make 
sense to compute such bounds to accelerate the solving process in the end. For this there are even more improvements 
one could try to make: In a graph there can be induced paths (i.e. neighboring vertices with degree 2). On a path the 
flow value has to be the same on each edge, so also the bounds have to be the same. 

Hence it is sufficient to compute the bound on one arc of a path and automatically set the same bound on the other 
arcs of this path.

Another improvement could be to immediately write the computed bounds into the network for all further computations. 
Currently every arcs bounds are computed on the same network with default flow bounds. It might improve the algorithm 
if the already computed bounds are set directly into the network and used when another arc is computed. It could also 
work to compute bounds only on a small selection of interesting arcs and propagate these bounds. In an incomplete 
acyclicity constraint separation algorithm like what we used for the gaslib-582 networks there are sometimes arcs where 
the MIP solver did find a good solution, while it did not find one on neighboring arcs. Since the heuristic in a way 
propagates flow bounds it even could improve the bounds to let the heuristic run again after setting the bounds already 
found.
There might also be different models or algorithms than the ones described in this thesis. The results show that in 
practice some relevant improvements on the flow bounds can be achieved by taking into account that gas flow has to be 
acyclic. It also shows the differences between cyclic and acyclic flow bounds can be huge not only in theory (the gap 
can be unbounded as we have shown) but also in practice.
