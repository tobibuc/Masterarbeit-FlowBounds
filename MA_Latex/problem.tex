We already described the gas flow problem, where the motivation for this thesis came from. Here we want to define the 
problem as a general combinatorial flow problem with specific contraints. We will also give the formulation as a Mixed 
Integer Program (MIP) and as well some natural relaxations, which might be easier to solve.

We will represent our originally undirected graph by a directed graph where flow is allowed to go over edges backward 
and forward as well. This allows us to specify directions forward and backward on every edge in a consistant way. 


\begin{definition}
 Let $G=(V,A)$ be a directed Graph and $e \in A$ a specific arc of $G$. For every vertex $v\in V$ let there be a 
prescribed amount of flow $b(v)\in \R$ entering or leaving the network, where $\sum_{v\in V}b(v)=0$. 

Let there be capacities $c_l(a)\le 0 \le c_u(a) \, \forall a\in A$, and a flow  $f: A\to \R $ with $c_l(a)\le f(a)\le 
c_u(a)\, \forall a\in A$ and $\sum_{a\in \delta^+(v)}f(a)-\sum_{a\in\delta^-(v)}f(a)+b(v) = 0 \, \forall v\in V$.
We call this flow a \textit{feasible network flow on G}.
\end{definition}

 %cycle was already defined in the Definitions chapter
\begin{definition}
A \textit{cyclic flow} within such a feasible network flow $f$ is a flow $f':C\to \R$, where $C\subseteq A$ is a cycle, 
$\sum_{a\in \delta^+(v)\cap C}f(a)-\sum_{a\in\delta^-(v)\cap C}f(a) = 0 \, \forall v\in C$ , for all arcs the flow 
directions in $f'$ and $f$ are the same, i.e. $f(a)\ge 0\Rightarrow f'(a)\ge 0,\, f(a)\le 0 \Rightarrow f'(a)\le 0$ and 
there is really non-zero flow, i.e. $f'(a) \ne 0 \,\forall a\in C$. 

If there is any cyclic flow $f'$ in a network flow $f$ we say that $f$ contains a flow cycle. If there is no cyclic 
flow, we say $f$ is an \textit{acyclic flow} on $G$.\\

The conditions imply, that a cyclic flow is one that has no sources or sinks and the same value of flow on each arc.

The \textit{size of a cyclic flow} is the absolute amount of of flow contributing to the cycle, that means it is the 
maximum value $|f'(a)|$ a cyclic flow $f'$ can reach. 
%flow $ f: C\to \R ,\, C\subseteq A \textrm{ a cycle, }\,c_l(a)\le 
%f(a)\le c_u(a)\, \forall a\in C$ with the property that 
\end{definition}
%TODO Kreisflussmenge, Kreisflusskapazität, Augmentierung


\begin{definition}
  Given a graph $G=(V,A)$ like above, with $e \in A$ a specific arc of $G$. 
  
  We call the problem of finding an acyclic flow $f:A\to \R$ with $f(e)\ge f'(e)\,\forall f':A\to \R \textrm{ s.t.} f' 
\textrm{ is an acyclic flow on }G$ the \textit{ Edge-Maximizing Acyclic Flow Problem}.
\end{definition}

Now that we defined our problem, we can investigate it deeper. It is obviously closely related to other flow problems, 
though the special constraints we built make it more complicated. One way to deal with this is to look at related 
problems, which could give bounds on our problem or even the same solution in special cases.

\subsection{Relation To Other Flow Problems}

If we look for related problems, it is natural to just drop the constraints of our problem. In this case we could for 
example easily forget the contraint that flows have to be acyclic. If we do this, our problem becomes a special 
instance of a Min-Cost-Flow where we allow edge weights to be negative:

\begin{definition}
 The \textit{Minimum Cost Flow Problem} is the problem to determine a feasible network flow with the least possible 
cost $c_f$. The cost function $c:A\to \R$ (or often $c:A\to \R_{\ge 0}$) is defined on every arc, the cost of the flow 
is $c_f = \sum_{a\in A}|f(a)|\cdot c(a)$. So for a given network and cost function we look for a flow $f$ s.t. $c_f\le 
c_{f'}\forall f':A\to \R$.
\end{definition}

This problem is normally defined with nonnegative cost functions, like in \cite{EdmondsKarp1972} where 
Jack Edmonds and Richard Karp present their well known $O(V\cdot E^2)$ flow algorithm. At least cycles of negative 
weight should be excluded, since they lead to problems in the algorithm's subroutines like shortest path. Nevertheless 
there are algorithms that can handle negative cycles without a problem - but they will of course give a solution 
where as much flow as possible is just flowing around these negative cycles. 
%, and make the problem hard. We will proof the hardness of this problem later.TODO auch ohne kreisfreiheit?

In our application we want to find upper and lower bounds on the possible flow over each arc. For this we set the 
weight on the arc $e$ where we want to maximize flow to -1 and compute a Minimum Cost Flow in the graph. If $e$ is 
contained in a cycle of $G$ whose arcs all have a very high upper capacity bound, $e$ will get a very high bound as 
well. The reason is that any cyclic flow over $e$ can reduce the cost of the flow. Hence as much cyclic flow as 
possible will be used to obtain a Minimum Cost Flow. 

So in most cases the bound computed with a Min-Cost Flow algorithm is not sharp. Still it gives an upper bound for the 
possible flow. Hence one could ask how good this bound will be, and whether we can use it as an approximation. It turns 
out that the gap between the amount of flow on an arc $e$ in an acyclic flow and in a possibly cyclic flow can be 
arbitrarily large:

\begin{prop}
 The gap between the maximum flow values $f(a)$ on an arc $a\in A$ in a normal and in an acyclic flow problem is 
unbounded. 
\end{prop}
\begin{proof}
 As a proof look at the two examples. 
 \begin{figure}[h!]
\centering
\begin{tikzpicture}
[scale=2, vertex/.style={circle,fill=black}]
\node (s) at (0,0)[vertex]{};
\node (stext) at (-0.1, -0.2){s, $b(s)=1$};
\node (t) at (2,0)[vertex]{} ;
\node (ttext) at (2.1, -0.2){t, $(b(t)=-1$};
\node (3) at (1,1.5)[vertex]{};
\node(etext) at (1.7,0.9){e};

\draw (s) -- (3);
\draw (s) -- (t);
  \begin{scope}[
    decoration={markings,mark=at position 0.5 with {\arrow{triangle 60}}}
    ]
    \draw[postaction={decorate}] (3) -- (t);
  \end{scope}
\end{tikzpicture}
 \end{figure}
In this first picture we see that the flow on the maximized arc $e$ in the acyclic case has to be 1. In the normal case 
it could be any number we choose as capacities for all arcs in the network. Hence the relative gap
$ \frac{f_{cyc}(e)}{f_{acyclic}(e)}$ is $\frac{\textrm{min capacity on the cycle}}{1}$ which is unbounded.
  
\begin{figure}[h!]
\centering
\begin{tikzpicture}
[scale=2, vertex/.style={circle,fill=black}]
\node (s) at (0,0)[vertex]{};
\node (stext) at (-0.1, 0.2){s};
\node (t) at (0,2)[vertex]{} ;
\node (ttext) at (-0.1, 1.8){t};
\node (3) at (1,1)[vertex]{};
\node (4) at (2,2)[vertex]{};
\node (5) at (2,0)[vertex]{};
\node(etext) at (1.4,1.6){e};

\draw (s) -- (3);
\draw (t) -- (3);
\draw (4) -- (5);
\draw (3) -- (5);
  \begin{scope}[
    decoration={markings,mark=at position 0.5 with {\arrow{triangle 60}}}
    ]
    \draw[postaction={decorate}] (3) -- (4);
  \end{scope}
\end{tikzpicture}
 
\end{figure}

The second picture shows a graph where the flow on $e$ in the acyclic case is $0$. If we do not forbid cyclic flows, 
the flow on $e$ will always be $\min_{a\in \textrm{ cycle }C}c_u(a)$. So the gap in relative numbers $ 
\frac{f_{cyc}(e)}{f_{acyclic}(e)}$ is not even defined!
\end{proof}

As a different relaxation we could drop the capacity constraints, but still insist on an acyclic flow that is maximum 
on an arc $e$. In the normal Max-Flow Problem this reduces the problem to finding a shortest path between the source 
and the sink. 

In our case , if there is only one source and one sink, we have to decide whether there is a simple path from the 
source to the sink that contains the maximized arc $e$. If there are more sources and sinks, we already have the 
problem of finding a set of simple paths. %TODO haerte des Problems? Wie loest man es?

%
Is this problem easy to solve, and how to solve it? TODO
%




\subsection{MIP Formulation}
For many combinatorial Problems it is the best practical solution to formulate them as a Mixed Integer Problem and just 
solve this problem with modern MIP Solvers such as CPlex or Gurobi. Often there are different possible formulations as 
MIP, which might yield very different running times due to numerical or algorithmical reasons. In our problem, it is 
easy to model the flow conservation and the ingoing and outgoing flow on vertices. Like described before, we can assign 
a negative weight to an arc variable and this way maximize flow over this arc by minimizing the overall cost. This 
would be the typical MIP formulation of a min cost flow:

\begin{align*}
  &\min \sum_{a\in A} w_a\cdot x_a  \\
 s.t. & \sum_{a\in \delta^+(v)}x_a - \sum_{a\in\delta^- (v)}x_a = b_v\ &\forall v\in V \\
  & c_l(a)\le x_a \le c_u(a) & \forall a\in A
\end{align*}

This model still allows cyclic flow, so we have to find constraints to avoid cyclicity. One idea (which 
was implemented in Lamatto by Robert Schwarz) is the following: Every arc has a direction and the sign of the flow on 
this arc tells us in which direction flow is send over this arc. Hence we can introduce variables $d_a\in \{0,1\}$ for 
each arc $a\in A$ that indicate the direction of flow and are coupled with the flow variables:
\begin{align*}
d_a=1 & \Rightarrow x_a\ge 0 \\
d_a=0 & \Rightarrow x_a\le 0
\end{align*}
These indicator constraints can be handled the way they are by standard MIP solvers, but to make them real MIP 
constraints we have to formulate them as follows (with $M$ a constant bigger than any possible $x_a$ , e.g. 
$M=\sum_{v\in V}|b_v|$) :
\begin{align*}
 x_a + M\cdot (1-d_a) &\ge 0\\
 x_a - M\cdot d_a & \le 0
\end{align*}



Now we have decision variables for the flow direction, we add constraints to avoid cycles. There should be at least 
one arc in each direction, so we get $$ 1\le\sum_{a\in C\textrm{ forward }} d_a + \sum_{a\in C\textrm{ backward 
}}1-d_a\le n-1$$
Let us formulate this in a slightly different way to get only one sum: For each cycle of size $C_n=C_l+C_m$ 
let $C_m$ be the number of arcs directed forward and $C_l$ the number of backward directed arcs. We define that always 
$C_l\le C_m$, so forward is defined as the direction where more arcs are pointing towards (left or right would only make 
sense in a planar embedding). Then we get the constraint $$1-l \le \sum_{a\in C}d_a\le n-(l+1)$$ that forbids any
cyclic flow on $C$. We will show later under which conditions such constraints also forbid cyclic flow on other cycles. 
%TODO was ist wenn gleich viele? Ist das als Definition so ueberhaupt ok?

So our MIP formulation of the model is finally
\begin{align*}
 &\min \sum_{a\in A} w_a\cdot x_a & \\
 s.t. & \sum_{a\in \delta^+(v)}x_a - \sum_{a\in\delta^- (v)}x_a = b_v\ &\forall v\in V \\
  & c_l(a)\le x_a \le c_u(a) & \forall a\in A\\
 &x_a + M\cdot (1-d_a) \ge 0 & \forall a\in A\\
 &x_a - M\cdot d_a \le 0 & \forall a\in A\\
 &1-l \le \sum_{a\in C}d_a \le n-(l+1) & \forall \textrm{ cycle }C\in G\\
 & x_a \in \R &\forall a\in A\\
 & d_a \in \{0,1\} &\forall a\in A
\end{align*}
or with only $\le$ inequalities:
\begin{align}
 &\min \sum_{a\in A} w_a\cdot x_a & \\
 s.t. & \sum_{a\in \delta^+(v)}x_a - \sum_{a\in\delta^- (v)}x_a &=& b_v\ &\forall v\in V \\
 & x_a &\le& c_u(a) & \forall a\in A\\
 & -x_a &\le& c_l(a) & \forall a\in A\\
 &-x_a - M\cdot (1-d_a) &\le& 0 & \forall a\in A\\
 &x_a - M\cdot d_a &\le& 0 & \forall a\in A\\
 &1-l - \sum_{a\in C}d_a &\le& 0 & \forall \textrm{ cycle }C\in G\\
 & \sum_{a\in C}d_a +(l+1)-n &\le& 0 & \forall \textrm{ cycle }C\in G\\
 & x_a \in \R & & &\forall a\in A\\
 & d_a \in \{0,1\} & & &\forall a\in A
\end{align}
%TODO gibt es noch andere Möglichkeiten als die von Robert? bestimmt!?

%TODO welche formulierungen koennte es noch geben fuer dieses problem?

Another idea (that is unfortunately not a linear formulation anymore) would be to set potentials on he nodes and allow 
only flow from higher to lower potential. This is quite close to reality, where gas will only flow from places wih high 
pressure to places with lower pressure in the network. So each vertex $v$ would become a variable $\pi_v$, each arc $a$ 
as before a variable $x_a$ for the amount of flow. We have to ensure that the values of the potentials are all 
different, or that there is no flow between nodes of the same potential. Otherwise any solution where all potentials 
are set to the same value would fulfill this constraint, regardless if it is acyclic or not. So in pracicewe could set 
a very small constant $\varepsilon > 0$ to describe the minimum distance between the potentials. A feasible solution 
now has to fulfill $$x_a\cdot (\pi_v -\pi_w)\ge 0\,\forall a=(v,w)\in A$$

We get the Mixed Integer Nonlinear Program
\begin{align*}
  &\min \sum_{a\in A} w_a\cdot x_a & \\
 s.t. & \sum_{a\in \delta^+(v)}x_a - \sum_{a\in\delta^- (v)}x_a &=& b_v\ &\forall v\in V \\
 & x_a &\le& c_u(a) & \forall a\in A\\
 & -x_a &\le& c_l(a) & \forall a\in A\\
 & -x_a\cdot (\pi_vx -\pi_w)&\le& 0 &\forall a=(v,w)\in A\\
 & (\pi_v - \pi_w)^2 &\ge& \varepsilon &\forall v,w \in V\\
 & x_a \in \R & & &\forall a\in A\\
 & \pi_v \in \R & & & \forall v\in V\\
 & d_a \in \{0,1\} & & &\forall a\in A\\
\end{align*}

We show that this flow indeed is an acyclic one:

\begin{prop}
 A flow which fulfills the constraints of the above nonlinear program is always acyclic.
\end{prop}
\begin{proof}
 Assume a flow fulfilling the above constraints would have cyclic flow on a cycle $C$. Without loss of generality 
we number the vertices on the cycle from $1$ to $n$ and assume all arcs are directed forward on this cycle. This means 
there are arcs $a_1=(v_1,v_2),a_2=(v_2,v_3), \dots a_n=(v_n, v_1)\in C$ such that $x_{a_i} > 0 \,\forall i={1,\dots , 
n}$. Also we know from the constraints  $x_a\cdot (\pi_v -\pi_w)\ge 0$ and $\pi_v - \pi_w \neq 0$ (Hence $\Rightarrow 
\pi_v\neq\pi_w)\, \forall v,w\in V$. So we conclude an ordering of the vertices potentials: $x_{a_1}\cdot (\pi_{v_1} 
-\pi_{v_2})\ge 0 \Rightarrow \pi_{v_1}>\pi_{v_2}$ and so on. This yields a sequence $\pi_{v_1}>\pi_{v_2}>\dots 
>\pi_{v_n}>\pi_{v_1}$, which is a contradiction. $\lightning$
\end{proof}




\subsection{The number of cycles we have to forbid}
