%main section about the different models 



\subsection{MIP Formulations}
For many combinatorial Problems it is the best practical solution to formulate them as a Mixed Integer Problem and just 
solve this problem with modern MIP Solvers such as CPlex or Gurobi. Often there are different possible formulations as 
MIP, which might yield very different running times due to numerical or algorithmical reasons. In our problem, it is 
easy to model the flow conservation and the ingoing and outgoing flow on vertices. Like described before, we can assign 
a negative weight to an arc variable and this way maximize flow over this arc by minimizing the overall cost. This 
would be the typical MIP formulation of a min cost flow:

\begin{align*}
  &\min \sum_{a\in A} w_a\cdot x_a  \\
  %TODO an die balance-intervall formulierung anpassen
 s.t. & \sum_{a\in \delta^+(v)}x_a - \sum_{a\in\delta^- (v)}x_a = d_v\ &\forall v\in V \\
  & c_l(a)\le x_a \le c_u(a) & \forall a\in A
\end{align*}

This model still allows cyclic flow, so we have to find constraints to avoid cyclicity. 
\subsubsection{Model 1: Node Potentials}
%TODO welche formulierungen koennte es noch geben fuer dieses problem?
%TODO PORTA results and polytope of the problem?

Another idea (that is unfortunately not a linear formulation anymore) would be to set potentials on he nodes and allow 
only flow from higher to lower potential. This is quite close to reality, where gas will only flow from places wih high 
pressure to places with lower pressure in the network. So each vertex $v$ would become a variable $\pi_v$, each arc $a$ 
as before a variable $x_a$ for the amount of flow. We have to ensure that the values of the potentials are all 
different, or that there is no flow between nodes of the same potential. Otherwise any solution where all potentials 
are set to the same value would fulfill this constraint, regardless if it is acyclic or not. So in pracicewe could set 
a very small constant $\varepsilon > 0$ to describe the minimum distance between the potentials. A feasible solution 
now has to fulfill $$x_a\cdot (\pi_v -\pi_w)\ge 0\,\forall a=(v,w)\in A$$

We get the Mixed Integer Nonlinear Program
\begin{align*}
  &\min \sum_{a\in A} w_a\cdot x_a & \\
 s.t. & \sum_{a\in \delta^+(v)}x_a - \sum_{a\in\delta^- (v)}x_a &=& b_v\ &\forall v\in V \\
 & x_a &\le& c_u(a) & \forall a\in A\\
 & -x_a &\le& c_l(a) & \forall a\in A\\
 & -x_a\cdot (\pi_vx -\pi_w)&\le& 0 &\forall a=(v,w)\in A\\
 & (\pi_v - \pi_w)^2 &\ge& \varepsilon &\forall v,w \in V\\
 & x_a \in \R & & &\forall a\in A\\
 & \pi_v \in \R & & & \forall v\in V\\
 & d_a \in \{0,1\} & & &\forall a\in A\\
\end{align*}

We show that this flow indeed is an acyclic one:

\begin{prop}
 A flow which fulfills the constraints of the above nonlinear program is always acyclic.
\end{prop}
\begin{proof}
 Assume a flow fulfilling the above constraints would have cyclic flow on a cycle $C$. Without loss of generality 
we number the vertices on the cycle from $1$ to $n$ and assume all arcs are directed forward on this cycle. This means 
there are arcs $a_1=(v_1,v_2),a_2=(v_2,v_3), \dots a_n=(v_n, v_1)\in C$ such that $x_{a_i} > 0 \,\forall i={1,\dots , 
n}$. Also we know from the constraints  $x_a\cdot (\pi_v -\pi_w)\ge 0$ and $\pi_v - \pi_w \neq 0$ (Hence $\Rightarrow 
\pi_v\neq\pi_w)\, \forall v,w\in V$. So we conclude an ordering of the vertices potentials: $x_{a_1}\cdot (\pi_{v_1} 
-\pi_{v_2})\ge 0 \Rightarrow \pi_{v_1}>\pi_{v_2}$ and so on. This yields a sequence $\pi_{v_1}>\pi_{v_2}>\dots 
>\pi_{v_n}>\pi_{v_1}$, which is a contradiction. \Lightning
\end{proof}

\subsubsection{Model 2: Acyclicity Constraints On All Cycles}

One idea (which was implemented in Lamatto by Robert Schwarz) is the following: Every arc has a direction and the sign 
of the flow on this arc tells us in which direction flow is send over this arc. Hence we can introduce variables 
$d_a\in 
\{0,1\}$ for each arc $a\in A$ that indicate the direction of flow and are coupled with the flow variables:
\begin{align*}
d_a=1 & \Rightarrow x_a\ge 0 \\
d_a=0 & \Rightarrow x_a\le 0
\end{align*}
These indicator constraints can be handled the way they are by standard MIP solvers, but to make them real MIP 
constraints we have to formulate them as follows (with $M$ a constant bigger than any possible $x_a$ , e.g. 
$M=\sum_{v\in V}|b_v|$) :
\begin{align*}
 x_a + M\cdot (1-d_a) &\ge 0\\
 x_a - M\cdot d_a & \le 0
\end{align*}



Now we have decision variables for the flow direction, we add constraints to avoid cycles. There should be at least 
one arc in each direction, so we get $$ 1\le\sum_{a\in C\textrm{ forward }} d_a + \sum_{a\in C\textrm{ backward 
}}1-d_a\le n-1$$
Let us formulate this in a slightly different way to get only one sum: For each cycle of size $C_n=C_l+C_m$ 
let $C_m$ be the number of arcs directed forward and $C_l$ the number of backward directed arcs. We define that always 
$C_l\le C_m$, so forward is defined as the direction where more arcs are pointing towards (left or right would only 
make 
sense in a planar embedding). Then we get the constraint $$1-l \le \sum_{a\in C}d_a\le n-(l+1)$$ that forbids any
cyclic flow on $C$. We will show later under which conditions such constraints also forbid cyclic flow on other cycles. 
%TODO was ist wenn gleich viele? Ist das als Definition so ueberhaupt ok?

So our MIP formulation of the model is finally
\begin{align*}
 &\min \sum_{a\in A} w_a\cdot x_a & \\
 s.t. & \sum_{a\in \delta^+(v)}x_a - \sum_{a\in\delta^- (v)}x_a = b_v\ &\forall v\in V \\
  & c_l(a)\le x_a \le c_u(a) & \forall a\in A\\
 &x_a + M\cdot (1-d_a) \ge 0 & \forall a\in A\\
 &x_a - M\cdot d_a \le 0 & \forall a\in A\\
 &1-l \le \sum_{a\in C}d_a \le n-(l+1) & \forall \textrm{ cycle }C\in G\\
 & x_a \in \R &\forall a\in A\\
 & d_a \in \{0,1\} &\forall a\in A
\end{align*}
or with only $\le$ inequalities:
\begin{align}
 &\min \sum_{a\in A} w_a\cdot x_a & \\
 s.t. & \sum_{a\in \delta^+(v)}x_a - \sum_{a\in\delta^- (v)}x_a &=& b_v\ &\forall v\in V \\
 & x_a &\le& c_u(a) & \forall a\in A\\
 & -x_a &\le& c_l(a) & \forall a\in A\\
 &-x_a - M\cdot (1-d_a) &\le& 0 & \forall a\in A\\
 &x_a - M\cdot d_a &\le& 0 & \forall a\in A\\
 &1-l - \sum_{a\in C}d_a &\le& 0 & \forall \textrm{ cycle }C\in G\\
 & \sum_{a\in C}d_a +(l+1)-n &\le& 0 & \forall \textrm{ cycle }C\in G\\
 & x_a \in \R & & &\forall a\in A\\
 & d_a \in \{0,1\} & & &\forall a\in A
\end{align}
%TODO gibt es noch andere MÃ¶glichkeiten als die von Robert? bestimmt!?



\subsection{The number of cycles we have to forbid}

\newpage
\subsection{A Path-Based Heuristic Approach}